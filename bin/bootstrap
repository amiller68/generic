#!/bin/bash

# bootstrap - Bootstrap a new server with Docker and accessories
# Runs kamal server bootstrap and boots postgres + redis for py service

set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

source "$PROJECT_ROOT/bin/utils"

# Hardcoded: service that has accessories
SERVICE="py"

# Hardcoded: accessories to boot (in order)
ACCESSORIES=(
    "postgres"
    "redis"
)

usage() {
    echo -e "${YELLOW}Bootstrap - Set up a new server${NC}"
    echo ""
    echo "Usage: $0 <stage>"
    echo ""
    echo "This will:"
    echo "  1. Run 'kamal server bootstrap' to install Docker"
    echo "  2. Boot postgres accessory"
    echo "  3. Boot redis accessory"
    echo ""
    echo "Examples:"
    echo "  $0 production"
    exit 1
}

if [[ $# -lt 1 ]]; then
    usage
fi

STAGE="$1"

print_header "Bootstrapping $STAGE server"

# Step 1: Bootstrap server (install Docker)
print_info "Step 1/3: Bootstrapping server with Docker..."
"$PROJECT_ROOT/bin/kamal" "$SERVICE" "$STAGE" server bootstrap

# Step 2-3: Boot accessories
step=2
for accessory in "${ACCESSORIES[@]}"; do
    print_info "Step $step/3: Booting $accessory accessory..."
    "$PROJECT_ROOT/bin/kamal" "$SERVICE" "$STAGE" accessory boot "$accessory"
    ((step++))
done

print_success "Bootstrap complete!"
echo ""
echo "Next steps:"
echo "  1. Deploy your app: ./bin/kamal $SERVICE $STAGE deploy"
echo "  2. Run migrations:  ./bin/kamal $SERVICE $STAGE app exec 'alembic upgrade head'"
