# Kamal deploy configuration for TypeScript Web service
service: generic-py

# NOTE: this must match the name you passed to the container registry module
# Container image
image: "<%= ENV['REGISTRY_NAME'] %>/generic-py"

# Deploy to these servers
servers:
  web:
    - "<%= ENV['DROPLET_IP'].strip %>"

# SSH configuration  
ssh:
  user: root
  key_data: ["<%= ENV['SSH_PRIVATE_KEY'] %>"]

# Registry configuration
registry:
  server: "<%= ENV['REGISTRY_ENDPOINT'] %>"
  username: "<%= ENV['DOCKERHUB_USERNAME'] %>"
  password:
    - DOCKERHUB_TOKEN

# Builder configuration
builder:
  dockerfile: py/Dockerfile
  context: "py"
  arch: amd64

# Proxy configuration for SSL
proxy:
  ssl: true
  host: py.generic.krondor.org
  app_port: 8000

# Environment variables
env:
  clear:
    POSTGRES_URL: "postgresql://generic_user:generic_pass@generic-py-postgres:5432/generic_py"
    HOST_NAME: https://py.generic.krondor.org
    AUTH_REDIRECT_URI: https://py.generic.krondor.org/auth/google/callback
  secret:
    - GOOGLE_CLIENT_ID
    - GOOGLE_CLIENT_SECRET

# Accessories (PostgreSQL database - internal only)
accessories:
  postgres:
    image: postgres:17-alpine
    host: "<%= ENV['DROPLET_IP'].strip %>"
    port: "5432:5432"
    env:
      clear:
        POSTGRES_DB: generic_py
        POSTGRES_USER: generic_user
        POSTGRES_PASSWORD: generic_pass
    directories:
      - data:/var/lib/postgresql/data