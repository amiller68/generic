service: <%= ENV['PROJECT_NAME'] %>-py

# NOTE (amiller68): do not change this!
# It is important that this is kept in sync with
#  the name of the service as described in the file
#  name.
# i.e. if the file name is py.yml, then the service name must be <%= ENV['PROJECT_NAME'] %>-py
# Container image using Docker Hub
image: <%= ENV['DOCKER_HUB_USERNAME'] %>/<%= ENV['PROJECT_NAME'] %>-py

# Deploy to these servers
servers:
  web:
    - "<%= ENV['SERVER_IP'].strip %>"

# SSH configuration
ssh:
  user: root
  keys: ["<%= ENV['SSH_PRIVATE_KEY_FILE'] %>"]
  keys_only: true

# Registry configuration for Docker Hub
registry:
  username: <%= ENV['DOCKER_HUB_USERNAME'] %>
  password:
    - DOCKER_HUB_TOKEN

# Builder configuration
builder:
  dockerfile: py/Dockerfile
  context: "."
  arch: amd64

# Proxy configuration for SSL
proxy:
  ssl: true
  host: <%= ENV['HOST_NAME'] %>
  app_port: 8000
  healthcheck:
    path: /up

# Environment variables
env:
  clear:
    POSTGRES_URL: postgresql://postgres:postgres@<%= ENV['PROJECT_NAME'] %>-py-postgres:5432/postgres
    # TODO (amiller68): this env is closer to DOMAIN_NAME in practice,
    #  since i have to add the scheme here
    HOST_NAME: https://<%= ENV['HOST_NAME'] %>
    DEBUG: false
  secret:
    - GOOGLE_O_AUTH_CLIENT_ID
    - GOOGLE_O_AUTH_CLIENT_SECRET

# Accessories (PostgreSQL database - internal only)
accessories:
  postgres:
    image: postgres:17-alpine
    host: "<%= ENV['SERVER_IP'].strip %>"
    port: "5432:5432"
    env:
      clear:
        POSTGRES_DB: postgres
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
    directories:
      - data:/var/lib/postgresql/data
